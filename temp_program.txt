using Printify.Application.Commands;
using Printify.Documents.Queries;
using Printify.Documents.Sessions;
using Printify.Domain.Config;
using Printify.Domain.Services;
using Printify.Services.BlobStorage;
using Printify.Services.Clock;
using Printify.Services.Listener;
using Printify.Services.Tokenizer;
using Printify.TestServices;
using BufferOptions = Printify.Domain.Config.BufferOptions;

var builder = WebApplication.CreateBuilder(args);

builder.Configuration.AddJsonFile("config.json", optional: false, reloadOnChange: true);

builder.Services.Configure<ListenerOptions>(builder.Configuration.GetSection("Listener"));
builder.Services.Configure<Page>(builder.Configuration.GetSection("Page"));
builder.Services.Configure<Storage>(builder.Configuration.GetSection("Storage"));
builder.Services.Configure<BufferOptions>(builder.Configuration.GetSection("Buffer"));

builder.Services.AddSingleton<IBlobStorage, FileSystemBlobStorage>();
builder.Services.AddSingleton<IRecordStorage, InMemoryRecordStorage>();
builder.Services.AddSingleton<IClockFactory, StopwatchClockFactory>();
builder.Services.AddSingleton<ITokenizer, EscPosTokenizer>();
builder.Services.AddSingleton<IResourceCommandService, ResourceCommandService>();
// Query service materializes descriptors and optional raster content for the API surface.
builder.Services.AddSingleton<IResourceQueryService, ResourceQueryService>();
builder.Services.AddSingleton<ISessionService, SessionService>();

builder.Services.AddSingleton<ListenerService>();
builder.Services.AddSingleton<IListenerService>(sp => sp.GetRequiredService<ListenerService>());

builder.Services.AddControllers();

var app = builder.Build();

var listener = app.Services.GetRequiredService<IListenerService>();
_ = listener.StartAsync(CancellationToken.None);
app.Lifetime.ApplicationStopping.Register(() => listener.StopAsync(CancellationToken.None).GetAwaiter().GetResult());

app.MapGet("/health", () => Results.Ok("OK"));
app.MapControllers();

app.Run();

public partial class Program;
