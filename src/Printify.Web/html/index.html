<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Printer Management</title>

<!-- UI Core Styles + Theme Tokens -->
<style>
/* -------------- COLOR TOKENS -------------- */
:root {
  --bg: #0e0f12;
  --bg-elev: #15171c;
  --text: #e9eaee;
  --muted: #b3b7c0;
  --border: #2a2d34;
  --accent: #10b981;
  --accent-hover: #0ea372;
  --danger: #ef4444;
  --warn: #f59e0b;
  --ok: #22c55e;
  --focus: #60a5fa;
  --hover-bg: rgba(255,255,255,0.08);
}

:root[data-theme="light"] {
  --bg: #f7f8fa;
  --bg-elev: #ffffff;
  --text: #0f1115;
  --muted: #585f6b;
  --border: #e5e7eb;
  --accent: #0ea372;
  --accent-hover: #0a8b61;
  --hover-bg: rgba(0,0,0,0.05);
}

/* -------------- BASE & TYPOGRAPHY -------------- */
html, body { height: 100%; }
html { color-scheme: light dark; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font: 400 16px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, Cantarell, Helvetica, Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

h1 { font-size: 30px; line-height: 38px; font-weight: 600; margin: 0 0 12px; }
h2 { font-size: 24px; line-height: 32px; font-weight: 600; margin: 24px 0 12px; }
h3 { font-size: 20px; line-height: 28px; font-weight: 600; margin: 16px 0 8px; }
p, ul, ol { margin: 8px 0 12px; }
small { font-size: 14px; line-height: 20px; color: var(--muted); }

/* -------------- LAYOUT PRIMITIVES -------------- */
.container {
  display: grid;
  grid-template-columns: 300px 1fr;
  grid-template-rows: 48px 1fr;
  grid-template-areas:
    "sidebar topbar"
    "sidebar main";
  height: 100dvh;
  transition: grid-template-columns 1.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.container.sidebar-hidden {
  grid-template-columns: 0px 1fr;
}
.sidebar { grid-area: sidebar; background: var(--bg-elev); border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; padding: 16px; overflow-y: auto; overflow-x: hidden; transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1), padding 1.2s cubic-bezier(0.4, 0, 0.2, 1); }
.container.sidebar-hidden .sidebar {
  opacity: 0;
  pointer-events: none;
  padding: 16px 0;
}
.topbar { grid-area: topbar; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; border-bottom: 1px solid var(--border); background: var(--bg); }
.main { grid-area: main; padding: 24px; overflow-y: auto; }
.main-inner { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }

/* -------------- UTILITIES -------------- */
.w100{width:100%}
.row{display:flex; align-items:center; gap:12px}
.col{display:flex; flex-direction:column; gap:12px}
.muted{color:var(--muted)}
.hidden{display:none}

/* -------------- CARDS -------------- */
.card { background: var(--bg-elev); border:1px solid var(--border); border-radius:12px; }
.card-header { padding: 12px 16px; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
.card-body { padding: 16px; }

/* -------------- BUTTONS -------------- */
.btn { border-radius:10px; padding:0 14px; height:36px; border:1px solid var(--border); background:var(--bg-elev); color:var(--text); display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none; font-size: 14px; font-weight: 500; }
.btn:hover { filter: brightness(1.1); }
.btn:active { transform: scale(0.985); }
.btn:focus { outline:2px solid var(--focus); outline-offset:2px; }
.btn[disabled] { opacity:.5; cursor:not-allowed; }

.btn-primary { background: var(--accent); border-color: transparent; color:#fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-secondary { background: var(--bg-elev); border-color: var(--border); }
.btn-ghost { background: transparent; border-color: transparent; }
.btn-danger { background: var(--danger); border-color: transparent; color:#fff; }
.btn-sm { height:28px; padding:0 10px; border-radius:8px; font-size: 13px; }

/* -------------- FORMS & INPUTS -------------- */
.label { font-weight: 600; font-size: 14px; margin-bottom: 6px; display: block; }
.field { display:flex; flex-direction:column; gap:6px; margin-bottom: 12px; }
.input, select, textarea { background: var(--bg-elev); color: var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; width: 100%; box-sizing: border-box; font-size: 14px; }
.input:focus, select:focus, textarea:focus { outline:2px solid var(--focus); outline-offset:2px; }
.input.invalid, select.invalid { border-color: var(--danger); outline: none; }
.input.invalid:focus, select.invalid:focus { outline: 2px solid var(--danger); outline-offset: 2px; }
.field-hint { color: var(--muted); font-size:13px; margin-top: -2px; }
.field-error { color: var(--danger); font-size:13px; margin-top: 2px; display: none; }
.field-error.show { display: block; }
.required::after { content: " *"; color: var(--danger); font-weight: 600; }
.form-actions { display:flex; gap:12px; justify-content:flex-end; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
.checkbox-field { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
.checkbox-field input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.checkbox-field label { font-size: 14px; font-weight: 500; margin: 0; cursor: pointer; }
.field-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.indent { margin-left: 26px; }

/* -------------- SIDEBAR LISTS -------------- */
.sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.sidebar-title { font-weight: 600; font-size: 18px; }
.sidebar-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border); }
.user-menu { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; cursor: pointer; transition: background-color 0.2s ease; position: relative; }
.user-menu:hover { background: rgba(255,255,255,0.06); }
.user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; flex-shrink: 0; }
.user-info { flex: 1; min-width: 0; }
.user-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-status { font-size: 12px; color: var(--muted); }
.icon-btn { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent; border: none; color: var(--text); cursor: pointer; border-radius: 8px; transition: background-color 0.2s ease; }
.icon-btn:hover { background: var(--hover-bg); }
.section-title { font-size:12px; letter-spacing:.04em; text-transform:uppercase; color:var(--muted); margin:16px 0 8px; font-weight: 600; }
.list { display:flex; flex-direction:column; gap:2px; }
.list-item { display:flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius:10px; color: var(--text); text-decoration:none; cursor: pointer; position: relative; padding-right: 44px; min-height: 44px; }
.list-item:hover { background: rgba(255,255,255,0.06); }
.list-item.active { background: rgba(16,185,129,0.15); border: 1px solid var(--accent); }
.list-item-icon { flex-shrink: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; color: var(--muted); }
.list-item-content { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 2px; }
.list-item-line1 { display: flex; align-items: center; gap: 6px; font-weight: 600; font-size: 15px; }
.list-item-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-item-line2 { font-size: 13px; color: var(--muted); line-height: 1.3; }
.list-item-badge { background: var(--accent); color: white; border-radius: 10px; padding: 1px 7px; font-size: 11px; font-weight: 600; line-height: 1.4; flex-shrink: 0; }
.list-item-menu { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0; font-weight: 900; font-size: 18px; line-height: 1; padding: 4px 8px; border-radius: 6px; transition: opacity 0.2s ease, background-color 0.2s ease; }
.list-item-menu:hover { background: var(--hover-bg); }
.list-item-menu:active { transform: translateY(-50%); }
.list-item-menu:focus { outline: none; }
.list-item:hover .list-item-menu { opacity: 1; }
.list-item-simple { padding: 10px 12px; padding-right: 44px; }
.list-item-new { border: 1px dashed var(--border); justify-content: center; font-weight: 600; padding-right: 12px; min-height: 44px; }
.list-item-new.temporary { border-style: dashed; border-width: 2px; }

/* -------------- MENU -------------- */
.menu { position: absolute; background: var(--bg-elev); border: 1px solid var(--border); border-radius: 10px; padding: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; min-width: 120px; }
.menu-item { padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; }
.menu-item:hover { background: rgba(255,255,255,0.06); }

/* -------------- MODAL -------------- */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200; }
.modal { background: var(--bg-elev); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
.modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 18px; }
.modal-body { padding: 20px; }

/* -------------- DOCUMENTS -------------- */
.document-item { background: var(--bg-elev); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
.document-preview { background: white; color: black; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 12px; line-height: 1.4; margin-bottom: 12px; white-space: pre-wrap; }
.document-meta { display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 14px; }
.document-actions { margin-left: auto; display: flex; gap: 8px; }

/* -------------- TOAST -------------- */
.toast-host { position: fixed; top:16px; right:16px; display:flex; flex-direction:column; gap:8px; z-index: 300; }
.toast { padding:12px 16px; border-radius:10px; border:1px solid var(--border); background: var(--bg-elev); box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
.toast.ok { border-color: var(--ok); background: color-mix(in srgb, var(--ok) 10%, var(--bg-elev)); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* -------------- THEME TOGGLE -------------- */
#themeToggle { position:fixed; bottom:16px; right:16px; z-index:70; }

/* -------------- TRANSITIONS -------------- */
* { transition: background-color .2s ease, color .2s ease, border-color .2s ease, filter .15s ease, transform .08s ease; }
@media (prefers-reduced-motion: reduce) { * { transition: none !important; animation: none !important; } }
</style>
</head>
<body>

<div class="container">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">Printers</span>
    </div>

    <nav class="list">
      <div class="list-item list-item-new" id="newPrinterBtn" onclick="openNewPrinterDialog()">
        <span id="newPrinterText">+ New printer</span>
      </div>
      <div id="tempPrinterHint" style="display: none; padding: 0 12px; font-size: 12px; color: var(--muted); margin-top: -2px;">
        Temporary printer - sign in to persist your configuration
      </div>
    </nav>

    <div class="section-title" id="tempSection" style="display: none;">Temporary Printers</div>
    <div class="section-title" id="pinnedSection" style="display: none;">Pinned</div>
    <nav class="list" id="pinnedList"></nav>

    <div class="section-title" id="otherSection" style="display: none;">Other</div>
    <nav class="list" id="otherList"></nav>

    <div class="sidebar-footer">
      <div class="user-menu" onclick="showUserMenu(event)">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-info">
          <div class="user-name" id="userName">Not signed in</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="row" style="gap: 8px;">
      <button class="icon-btn" onclick="toggleSidebar()" title="Toggle sidebar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="9" y1="3" x2="9" y2="21"></line>
        </svg>
      </button>
      <div id="topbarTitle" style="font-weight: 600;">Select a printer</div>
    </div>
    <div class="row">
      <button class="icon-btn" onclick="toggleTheme()" title="Toggle theme">
        <svg id="themeIconDark" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <svg id="themeIconLight" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="main">
    <div class="main-inner" id="mainContent">
      <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
        <h2>Welcome to Printer Management</h2>
        <p>Select a printer from the sidebar to view documents</p>
      </div>
    </div>
  </main>
</div>

<!-- TOAST HOST -->
<div class="toast-host" id="toastHost"></div>

<!-- THEME TOGGLE -->
<button id="themeToggle" class="btn btn-ghost" onclick="toggleTheme()" style="display: none;">
  <span id="themeIcon">☀️</span>
</button>

<!-- MODAL TEMPLATE -->
<div id="modalContainer"></div>

<script>
// Mock Data
let printers = [];

let users = ['Alexey Ivanov', 'Sergey Sergeev'];
let currentUser = null;
let sessionPrinters = [];

let documents = {};

let selectedPrinterId = null;

// Utility Functions
function formatRelativeTime(date) {
  const now = new Date();
  const diff = now - date;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 1) return 'just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days === 1) return 'yesterday';
  if (days < 7) return `${days}d ago`;
  return date.toLocaleDateString();
}

function formatDateTime(date) {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${day}.${month}.${year} ${hours}:${minutes}`;
}

function showToast(message, type = 'ok') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.getElementById('toastHost').appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Render Functions
function renderSidebar() {
  const pinnedList = document.getElementById('pinnedList');
  const otherList = document.getElementById('otherList');

  const pinnedPrinters = printers.filter(p => p.pinned).sort((a, b) => a.pinOrder - b.pinOrder);
  const otherPrinters = printers.filter(p => !p.pinned).sort((a, b) => {
    if (a.owner !== b.owner) return a.owner.localeCompare(b.owner);
    return a.name.localeCompare(b.name);
  });

  pinnedList.innerHTML = pinnedPrinters.map(p => `
    <div class="list-item ${selectedPrinterId === p.id ? 'active' : ''}" onclick="selectPrinter(${p.id})">
      <div class="list-item-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="17" x2="12" y2="22"></line>
          <path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path>
        </svg>
      </div>
      <div class="list-item-content">
        <div class="list-item-line1">
          <span class="list-item-name">${p.name}</span>
          ${p.newDocs > 0 ? `<span class="list-item-badge">● ${p.newDocs}</span>` : ''}
        </div>
        <div class="list-item-line2">Last: ${formatDateTime(p.lastDocumentAt)} · ${formatRelativeTime(p.lastDocumentAt)}</div>
      </div>
      <button class="btn btn-ghost btn-sm list-item-menu" onclick="event.stopPropagation(); showMenu(event, ${p.id}, true)">⋯</button>
    </div>
  `).join('');

  otherList.innerHTML = otherPrinters.map(p => `
    <div class="list-item ${selectedPrinterId === p.id ? 'active' : ''}" onclick="selectPrinter(${p.id})">
      <div class="list-item-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 6 2 18 2 18 9"></polyline>
          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
          <rect x="6" y="14" width="12" height="8"></rect>
        </svg>
      </div>
      <div class="list-item-content">
        <div class="list-item-line1">
          <span class="list-item-name">${p.name}</span>
        </div>
        <div class="list-item-line2">by ${p.owner}</div>
      </div>
      <button class="btn btn-ghost btn-sm list-item-menu" onclick="event.stopPropagation(); showMenu(event, ${p.id}, false)">⋯</button>
    </div>
  `).join('');
}

function selectPrinter(id) {
  selectedPrinterId = id;
  const printer = printers.find(p => p.id === id);
  if (printer) {
    printer.newDocs = 0;
    document.getElementById('topbarTitle').textContent = `${printer.name} · ${printer.protocol} · ${printer.width} dots`;
    renderDocuments();
    renderSidebar();
  }
}

function renderDocuments() {
  const mainContent = document.getElementById('mainContent');
  
  if (!selectedPrinterId) {
    // Show welcome screen if not logged in
    if (!currentUser) {
      mainContent.innerHTML = `
        <div style="max-width: 600px; margin: 60px auto; text-align: center;">
          <h1>Printer Management System</h1>
          <p style="color: var(--muted); font-size: 18px; margin: 24px 0 40px; line-height: 1.6;">
            Manage receipt and label printers with real-time document streaming
          </p>
          
          <div style="text-align: left; background: var(--bg-elev); border: 1px solid var(--border); border-radius: 12px; padding: 32px; margin-bottom: 32px;">
            <h3 style="margin-top: 0;">Features</h3>
            <ul style="color: var(--muted); line-height: 1.8; padding-left: 24px;">
              <li>Configure multiple printers with ESC/POS, ZPL, and other protocols</li>
              <li>Monitor print jobs in real-time with document preview</li>
              <li>Replay and download previously printed documents</li>
              <li>Pin frequently used printers for quick access</li>
              <li>Emulate buffer capacity for testing and optimization</li>
              <li>Organize printers by width, protocol, and owner</li>
            </ul>
          </div>
          
          <div style="background: rgba(16,185,129,0.1); border: 1px solid var(--accent); border-radius: 12px; padding: 24px; margin-bottom: 32px;">
            <h3 style="margin-top: 0; color: var(--accent);">Sign in to save your configuration</h3>
            <p style="color: var(--muted); margin-bottom: 16px;">
              Without an account, your printer list is temporary and will be lost when you close the browser.
            </p>
            <button class="btn btn-primary" onclick="showLoginDialog()">Sign in</button>
          </div>
          
          <p style="color: var(--muted); font-size: 14px;">
            You can create temporary printers without signing in to try out the system.
          </p>
        </div>
      `;
      return;
    }
    
    // Show logged-in empty state
    mainContent.innerHTML = `
      <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
        <h2>Welcome back, ${currentUser}</h2>
        <p>Select a printer from the sidebar to view documents</p>
      </div>
    `;
    return;
  }
  
  const docs = documents[selectedPrinterId] || [];

  if (docs.length === 0) {
    mainContent.innerHTML = `
      <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
        <h3>No documents yet</h3>
        <p>Documents will appear here when they are printed</p>
      </div>
    `;
    return;
  }

  mainContent.innerHTML = docs.map(doc => `
    <div class="document-item">
      <div class="document-preview">${doc.content}</div>
      <div class="document-meta">
        <span>${formatRelativeTime(doc.timestamp)}</span>
        <div class="document-actions">
          <button class="btn btn-secondary btn-sm" onclick="downloadDocument(${doc.id})">Download</button>
          <button class="btn btn-secondary btn-sm" onclick="replayDocument(${doc.id})">Replay</button>
        </div>
      </div>
    </div>
  `).join('');
}

function showMenu(event, printerId, isPinned) {
  event.stopPropagation();
  
  const existingMenu = document.querySelector('.menu');
  if (existingMenu) existingMenu.remove();

  const menu = document.createElement('div');
  menu.className = 'menu';
  menu.style.position = 'fixed';
  menu.style.left = event.clientX + 'px';
  menu.style.top = event.clientY + 'px';

  // Only show pin/unpin if user is logged in
  if (currentUser) {
    menu.innerHTML = `
      <div class="menu-item" onclick="editPrinter(${printerId})">Edit</div>
      <div class="menu-item" onclick="togglePin(${printerId})">${isPinned ? 'Unpin' : 'Pin'}</div>
    `;
  } else {
    menu.innerHTML = `
      <div class="menu-item" onclick="editPrinter(${printerId})">Edit</div>
    `;
  }

  document.body.appendChild(menu);

  setTimeout(() => {
    document.addEventListener('click', function closeMenu() {
      menu.remove();
      document.removeEventListener('click', closeMenu);
    });
  }, 0);
}

function togglePin(printerId) {
  const printer = printers.find(p => p.id === printerId);
  if (printer) {
    printer.pinned = !printer.pinned;
    if (printer.pinned) {
      printer.pinOrder = printers.filter(p => p.pinned).length;
    }
    renderSidebar();
    showToast(printer.pinned ? 'Printer pinned' : 'Printer unpinned');
  }
}

function openNewPrinterDialog() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">New Printer</div>
      <div class="modal-body">
        <div class="field">
          <label class="label required">Name</label>
          <input class="input" id="printerName" placeholder="e.g., Kitchen Printer" />
          <div class="field-error" id="nameError">Name is required</div>
        </div>
        
        <div class="field-group">
          <div class="field">
            <label class="label required">Protocol</label>
            <select class="input" id="printerProtocol">
              <option>ESC/POS</option>
              <option>Star Line Mode</option>
              <option>ZPL</option>
              <option>EPL</option>
            </select>
          </div>
          
          <div class="field">
            <label class="label">Width (dots)</label>
            <input class="input" id="printerWidth" type="number" value="576" />
            <div class="field-hint">Paper width in dots</div>
          </div>
        </div>
        
        <div class="checkbox-field">
          <input type="checkbox" id="emulateBuffer" onchange="toggleBufferFields()" />
          <label for="emulateBuffer">Emulate buffer capacity</label>
        </div>
        
        <div id="bufferFields" class="indent" style="display: none;">
          <div class="field-group">
            <div class="field">
              <label class="label">Buffer size (bytes)</label>
              <input class="input" id="bufferSize" type="number" value="4096" />
              <div class="field-hint">Internal buffer size</div>
            </div>
            
            <div class="field">
              <label class="label">Drain rate (bytes/s)</label>
              <input class="input" id="drainRate" type="number" value="4096" />
              <div class="field-hint">Processing speed</div>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="createPrinter()">Create</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('modalContainer').appendChild(modal);
}

function toggleBufferFields() {
  const checked = document.getElementById('emulateBuffer').checked;
  document.getElementById('bufferFields').style.display = checked ? 'block' : 'none';
}

function editPrinter(printerId) {
  const printer = printers.find(p => p.id === printerId);
  if (!printer) return;

  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">Edit Printer</div>
      <div class="modal-body">
        <div class="field">
          <label class="label required">Name</label>
          <input class="input" id="printerName" value="${printer.name}" />
          <div class="field-error" id="nameError">Name is required</div>
        </div>
        
        <div class="field">
          <label class="label required">Owner</label>
          <input class="input" id="printerOwner" list="ownerList" value="${printer.owner}" />
          <datalist id="ownerList">
            ${users.map(u => `<option value="${u}">`).join('')}
          </datalist>
          <div class="field-error" id="ownerError">Owner is required</div>
        </div>
        
        <div class="field-group">
          <div class="field">
            <label class="label required">Protocol</label>
            <select class="input" id="printerProtocol">
              <option ${printer.protocol === 'ESC/POS' ? 'selected' : ''}>ESC/POS</option>
              <option ${printer.protocol === 'Star Line Mode' ? 'selected' : ''}>Star Line Mode</option>
              <option ${printer.protocol === 'ZPL' ? 'selected' : ''}>ZPL</option>
              <option ${printer.protocol === 'EPL' ? 'selected' : ''}>EPL</option>
            </select>
          </div>
          
          <div class="field">
            <label class="label">Width (dots)</label>
            <input class="input" id="printerWidth" type="number" value="${printer.width}" />
            <div class="field-hint">Paper width in dots</div>
          </div>
        </div>
        
        <div class="checkbox-field">
          <input type="checkbox" id="emulateBuffer" ${printer.emulateBuffer ? 'checked' : ''} onchange="toggleBufferFields()" />
          <label for="emulateBuffer">Emulate buffer capacity</label>
        </div>
        
        <div id="bufferFields" class="indent" style="display: ${printer.emulateBuffer ? 'block' : 'none'};">
          <div class="field-group">
            <div class="field">
              <label class="label">Buffer size (bytes)</label>
              <input class="input" id="bufferSize" type="number" value="${printer.bufferSize}" />
              <div class="field-hint">Internal buffer size</div>
            </div>
            
            <div class="field">
              <label class="label">Drain rate (bytes/s)</label>
              <input class="input" id="drainRate" type="number" value="${printer.drainRate}" />
              <div class="field-hint">Processing speed</div>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="updatePrinter(${printerId})">Save</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('modalContainer').appendChild(modal);
}

function createPrinter() {
  const name = document.getElementById('printerName').value.trim();
  const protocol = document.getElementById('printerProtocol').value;
  const width = parseInt(document.getElementById('printerWidth').value) || 576;
  const emulateBuffer = document.getElementById('emulateBuffer').checked;
  const bufferSize = parseInt(document.getElementById('bufferSize').value) || 4096;
  const drainRate = parseInt(document.getElementById('drainRate').value) || 4096;

  // Validation
  let isValid = true;
  const nameInput = document.getElementById('printerName');
  const nameError = document.getElementById('nameError');

  // Reset errors
  nameInput.classList.remove('invalid');
  nameError.classList.remove('show');

  if (!name) {
    nameInput.classList.add('invalid');
    nameError.classList.add('show');
    nameInput.focus();
    return;
  }

  const newPrinter = {
    id: printers.length + 1,
    name,
    owner: currentUser || 'Anonymous',
    protocol,
    width,
    emulateBuffer,
    bufferSize,
    drainRate,
    pinned: false, // Always false for new printers in anonymous mode
    permanent: !!currentUser,
    lastDocumentAt: new Date(),
    newDocs: 0,
    pinOrder: printers.filter(p => p.pinned).length
  };

  console.log('=== CREATE PRINTER ===');
  console.log('Adding printer:', newPrinter);
  printers.push(newPrinter);
  console.log('Total printers now:', printers.length);
  documents[newPrinter.id] = [];
  
  closeModal();
  console.log('About to call renderSidebar');
  renderSidebar();
  console.log('renderSidebar called');
  selectPrinter(newPrinter.id);
  showToast('Printer created successfully');
}

function updatePrinter(printerId) {
  const printer = printers.find(p => p.id === printerId);
  if (!printer) return;

  const name = document.getElementById('printerName').value.trim();
  const protocol = document.getElementById('printerProtocol').value;
  const width = parseInt(document.getElementById('printerWidth').value) || 576;
  const emulateBuffer = document.getElementById('emulateBuffer').checked;
  const bufferSize = parseInt(document.getElementById('bufferSize').value) || 4096;
  const drainRate = parseInt(document.getElementById('drainRate').value) || 4096;

  // Validation
  const nameInput = document.getElementById('printerName');
  const nameError = document.getElementById('nameError');

  // Reset errors
  nameInput.classList.remove('invalid');
  nameError.classList.remove('show');

  if (!name) {
    nameInput.classList.add('invalid');
    nameError.classList.add('show');
    nameInput.focus();
    return;
  }

  printer.name = name;
  printer.protocol = protocol;
  printer.width = width;
  printer.emulateBuffer = emulateBuffer;
  printer.bufferSize = bufferSize;
  printer.drainRate = drainRate;

  closeModal();
  renderSidebar();
  if (selectedPrinterId === printerId) {
    document.getElementById('topbarTitle').textContent = `${name} · ${protocol} · ${width} dots`;
  }
  showToast('Printer updated successfully');
}

function closeModal() {
  document.getElementById('modalContainer').innerHTML = '';
}

function downloadDocument(docId) {
  showToast('Download started');
}

function replayDocument(docId) {
  showToast('Document replayed');
}

// Theme Functions
function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  updateThemeIcon(next);
}

function updateThemeIcon(theme) {
  const darkIcon = document.getElementById('themeIconDark');
  const lightIcon = document.getElementById('themeIconLight');
  if (theme === 'dark') {
    darkIcon.style.display = 'block';
    lightIcon.style.display = 'none';
  } else {
    darkIcon.style.display = 'none';
    lightIcon.style.display = 'block';
  }
}

function initTheme() {
  const html = document.documentElement;
  const saved = localStorage.getItem('theme') || 'dark';
  html.setAttribute('data-theme', saved);
  updateThemeIcon(saved);
}

function toggleSidebar() {
  const container = document.querySelector('.container');
  container.classList.toggle('sidebar-hidden');
  
  // Save state
  const isHidden = container.classList.contains('sidebar-hidden');
  localStorage.setItem('sidebarHidden', isHidden);
}

function getInitials(name) {
  if (!name) return '?';
  const parts = name.trim().split(' ');
  if (parts.length >= 2) {
    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
  }
  return parts[0].substring(0, 2).toUpperCase();
}

function updateUserDisplay() {
  const avatar = document.getElementById('userAvatar');
  const userName = document.getElementById('userName');
  const newPrinterText = document.getElementById('newPrinterText');
  const newPrinterBtn = document.getElementById('newPrinterBtn');
  const tempPrinterHint = document.getElementById('tempPrinterHint');
  
  if (currentUser) {
    avatar.textContent = getInitials(currentUser);
    userName.textContent = currentUser;
    newPrinterText.textContent = '+ New printer';
    newPrinterBtn.classList.remove('temporary');
    tempPrinterHint.style.display = 'none';
  } else {
    avatar.textContent = '?';
    userName.textContent = 'Not signed in';
    newPrinterText.textContent = '+ New temporary printer';
    newPrinterBtn.classList.add('temporary');
    tempPrinterHint.style.display = 'block';
  }
  
  // Update main content if no printer is selected
  if (!selectedPrinterId) {
    renderDocuments();
  }
  
  // Update sidebar rendering for anonymous/logged-in modes
  renderSidebar();
}

function showUserMenu(event) {
  event.stopPropagation();
  
  const existingMenu = document.querySelector('.menu');
  if (existingMenu) existingMenu.remove();

  const menu = document.createElement('div');
  menu.className = 'menu';
  menu.style.position = 'fixed';
  menu.style.left = event.currentTarget.getBoundingClientRect().left + 'px';
  menu.style.bottom = (window.innerHeight - event.currentTarget.getBoundingClientRect().top) + 'px';

  if (currentUser) {
    menu.innerHTML = `
      <div class="menu-item" onclick="showLoginDialog()">Switch user</div>
      <div style="border-top: 1px solid var(--border); margin: 4px 0;"></div>
      <div class="menu-item" onclick="logOut()">Log out</div>
    `;
  } else {
    menu.innerHTML = `<div class="menu-item" onclick="showLoginDialog()">Log in</div>`;
  }

  document.body.appendChild(menu);

  setTimeout(() => {
    document.addEventListener('click', function closeMenu() {
      menu.remove();
      document.removeEventListener('click', closeMenu);
    });
  }, 0);
}

function showLoginDialog() {
  const hasTemporaryPrinters = printers.some(p => !p.permanent);
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal">
      <div class="modal-header">Log in</div>
      <div class="modal-body">
        <div class="field">
          <label class="label">Select or enter your name</label>
          <input class="input" id="loginName" list="loginUserList" placeholder="Select or type your name" />
          <datalist id="loginUserList">
            ${users.map(u => `<option value="${u}">`).join('')}
          </datalist>
        </div>
        ${hasTemporaryPrinters ? `
          <div class="checkbox-field">
            <input type="checkbox" id="saveTemporary" checked />
            <label for="saveTemporary">Save temporary printers from this session</label>
          </div>
          <div style="font-size: 13px; color: var(--muted); margin-left: 26px; margin-top: -8px;">
            ${printers.filter(p => !p.permanent).length} temporary printer(s) will be saved to your account
          </div>
        ` : ''}
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="logIn()">Log in</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('modalContainer').appendChild(modal);
  setTimeout(() => document.getElementById('loginName').focus(), 100);
}

function logIn() {
  const name = document.getElementById('loginName').value.trim();
  
  if (!name) {
    showToast('Please enter your name', 'err');
    return;
  }

  // Add new user to list if not exists
  if (!users.includes(name)) {
    users.push(name);
  }

  // Check if user wants to save temporary printers
  const saveTemporaryCheckbox = document.getElementById('saveTemporary');
  const shouldSaveTemporary = saveTemporaryCheckbox ? saveTemporaryCheckbox.checked : false;

  if (shouldSaveTemporary) {
    // Mark all current printers as permanent
    printers.forEach(p => {
      p.permanent = true;
      p.owner = name; // Assign to logged-in user
    });
  } else {
    // Remove temporary printers
    const tempPrinterIds = printers.filter(p => !p.permanent).map(p => p.id);
    printers = printers.filter(p => p.permanent);
    
    // Clean up documents for removed printers
    tempPrinterIds.forEach(id => {
      delete documents[id];
    });
  }

  currentUser = name;
  localStorage.setItem('currentUser', name);
  
  // Reset selection if current printer was temporary and removed
  if (selectedPrinterId && !printers.find(p => p.id === selectedPrinterId)) {
    selectedPrinterId = null;
  }
  
  updateUserDisplay();
  renderSidebar();
  closeModal();
  showToast(`Logged in as ${name}`);
}

function logOut() {
  // Nuclear option: clear everything and reload
  localStorage.removeItem('currentUser');
  localStorage.removeItem('sidebarHidden');
  
  // Reload page for fresh anonymous session
  window.location.reload();
}

// Initialize
initTheme();
updateUserDisplay();
renderSidebar();

// Restore sidebar state
const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
if (sidebarHidden) {
  document.querySelector('.container').classList.add('sidebar-hidden');
}

// Restore user state
const savedUser = localStorage.getItem('currentUser');
if (savedUser) {
  currentUser = savedUser;
  updateUserDisplay();
  renderSidebar();
}
</script>

</body>
</html>